<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link href="datatables/1.10.19/css/dataTables.bootstrap4.min.css" rel="stylesheet" />
    <link id="dark-theme" href="https://bootswatch.com/4/darkly/bootstrap.css" rel="stylesheet" />

    <title>Provisions</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Provisions</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarText">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a id="register-link" class="nav-link" data-toggle="modal" data-target="#registerModal" href="#">Rejestracja</a>
            </li>
            <li class="nav-item">
              <a id="login-link" class="nav-link" data-toggle="modal" data-target="#loginModal" href="#">Logowanie</a>
            </li>
            <li class="nav-item">
              <a id="provisions-link" class="nav-link" data-target="#" href="#">Postanowienia</a>
            </li>
            <li class="nav-item">
              <a id="days-link" class="nav-link" data-toggle="modal" data-target="#" href="#">Dni</a>
            </li>
            <li class="nav-item">
              <a id="logout-link" class="nav-link" data-toggle="modal" data-target="#" href="#">Wyloguj się</a>
            </li>
          </ul>
        </div>
        <button class="btn btn-secondary" id="blind-btn">Zmień motyw</button>
      </nav>

      

      <!-- Modal -->
      <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="loginModalLabel">Logowanie</h5>
              <button type="button" class="close" data-dismiss="modal" id="login-close-btn" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="login-form">
                <div class="form-group">
                  <label for="loginUserName">Nazwa użytkownika</label>
                  <input type="login" class="form-control" id="loginUserName">
                </div>
                <div class="form-group">
                  <label for="loginPasswordInput">Hasło</label>
                  <input type="password" class="form-control" id="loginPasswordInput">
                </div>
                <button type="submit" class="btn btn-primary" id="login-submit">Zaloguj się</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="addProvisionModal" tabindex="-1" role="dialog" aria-labelledby="addProvisionModal" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addProvisionModal">Dodawanie nowego postanowienia</h5>
              <button type="button" class="close" data-dismiss="modal" id="addProvision-close-btn" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="login-form">
                <div class="form-group">
                  <label for="loginUserName">Nazwa postanowienia</label>
                  <input type="text" class="form-control" id="provisionInput">
                </div>
                <div class="form-group">
                  <label for="startDateInput">Data startu</label>
                  <input type="datetime-local" class="form-control" value="2020-06-15T13:00" id="startDateInput">
                </div>
                <div class="form-group">
                  <label for="endDateInput">Data zakończenia</label>
                  <input type="datetime-local" class="form-control" value="2021-06-16T13:00" id="endDateInput">
                </div>
                <div class="form-group">
                  <label for="provisionDescription">Opis postanowienia</label>
                  <input type="text" class="form-control" id="provisionDescription">
                </div>
                <button type="submit" class="btn btn-primary" id="add-provision-btn">Dodaj</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="addDaysModal" tabindex="-1" role="dialog" aria-labelledby="addDaysModal" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addDaysModal">Dodawanie nowego dnia</h5>
              <button type="button" class="close" data-dismiss="modal" id="addDay-close-btn" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="login-form">
                <div class="form-group">
                  <label for="provisionSelection">Nazwa postanowienia</label>
                  <select class="form-control" id="provisionSelection">
                    <script>
                      window.addEventListener('load', () => {
                        setInterval(()=> {if (localStorage.getItem('token') !== null && localStorage.getItem('provisionsSet') === null) {
                          localStorage.setItem('provisionsSet', true);
                          let messageScreen = document.getElementById('message-screen');
                          fetch(apiUrl+'/api/provisions/get',{
                            method: 'GET',
                            headers: {
                              'Content-Type': 'application/json',
                              'Authorization': 'Bearer '+localStorage.getItem('token')
                            }
                          })
                          .then(response => {
                            console.log(response);
                            if(response.status !== 200) {
                              throw new Error(response.statusText);
                            } else {
                              return response.json();
                            }
                          })
                          .then(data => {
                            let provisionsSelection = document.getElementById("provisionSelection");
                            for(let i=0; i<data.length; i++) {
                              let option = document.createElement("option");
                              option.value = data[i].id;
                              option.innerHTML = data[i].name;
                              provisionsSelection.appendChild(option)
                            }
                          })
                          .catch(error => {
                            console.error(error)
                            //messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">' + error + '!</div>';
                          });

                        }}, 1000);
                      });
                    </script>
                  </select>
                </div>
                <div class="form-group">
                  <label for="dayDateInput">Data</label>
                  <input type="datetime-local" class="form-control" value="2020-06-15T13:00" id="dayDateInput">
                </div>
                <div class="form-group">
                  <label for="StatusInput">Status wykonania</label>
                  <select class="form-control" id="StatusInput">
                    <script>
                    window.addEventListener('load', () => {
                      setInterval(() => { if (localStorage.getItem('token') !== null && localStorage.getItem('statusSet') === null) {
                        localStorage.setItem('statusSet', true);
                        let messageScreen = document.getElementById('message-screen');
                        fetch(apiUrl+'/api/status/get',{
                          method: 'GET',
                          headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer '+localStorage.getItem('token')
                          }
                        })
                        .then(response => {
                          if(response.status !== 200) {
                            throw new Error(response.statusText);
                          } else {
                            return response.json();
                          }
                        })
                        .then(data => {
                          let statusSelection = document.getElementById("StatusInput");
                          for(let i=0; i<data.length; i++) {
                            let option = document.createElement("option");
                            option.value = data[i].state;
                            option.innerHTML = data[i].name; 
                            statusSelection.appendChild(option)
                          }
                        })
                        .catch(error => {
                          console.error(error)
                          //messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">' + error + '!</div>';
                        });
                      }}, 1000);
                    });
                    </script>
                  </select>
                </div>
                <div class="form-group">
                  <label for="dayDescription">Opis</label>
                  <input type="text" class="form-control" id="dayDescription">
                </div>
                <button type="submit" class="btn btn-primary" id="add-day-btn">Dodaj</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="registerModalLabel">Rejestracja</h5>
              <button type="button" class="close" id="register-close-btn" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="register-form">
                <div class="form-group">
                  <label for="registerUserName">Nazwa użytkownika</label>
                  <input type="text" class="form-control" id="registerUserName" minlength="5" maxlength="25" required>
                </div>
                <div class="form-group">
                  <label for="registerEmail">Email</label>
                  <input type="text" class="form-control" id="registerEmail" required>
                </div>
                <div class="form-group">
                  <label for="registerPasswordInput">Hasło</label>
                  <input type="password" class="form-control" id="registerPasswordInput" minlength="8" maxlength="25" required>
                </div>
                <div class="form-group">
                  <label for="registerPasswordConfirmInput">Powtórz hasło</label>
                  <input type="password" class="form-control" id="registerPasswordConfirmInput" minlength="8" maxlength="25" required>
                </div>
                <button type="submit" class="btn btn-primary" id="register-submit">Rejestracja</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div id="message-screen">

      </div>

      <div id="home-screen">

      </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="datatables/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="datatables/1.10.19/js/dataTables.bootstrap4.min.js"></script>
    <!-- <script src="tableInitializer.js"></script> -->
    <script>
      //TODO: Wersja testowa, do refactoringu

      const apiUrl = 'http://localhost:5000';

      window.addEventListener('beforeunload', () => {
        if (localStorage.getItem('provisionsSet') !== null) {
          localStorage.removeItem('provisionsSet');
        }
        if (localStorage.getItem('statusSet') !== null) {
          localStorage.removeItem('statusSet');
        }
      });

      window.addEventListener('load', () => {

        let blindBtn = document.getElementById('blind-btn');
        let addNewProvision = null;
        let registerBtn = document.getElementById('register-link');
        let loginBtn = document.getElementById('login-link');
        let logoutBtn = document.getElementById('logout-link');

        let loginHandler = document.getElementById('login-submit');
        let registerHandler = document.getElementById('register-submit');

        let homeScreen = document.getElementById('home-screen');

        let addProvisionHandler = document.getElementById('add-provision-btn');

        let provisionsList = document.getElementById('provisions-link');
        let daysList = document.getElementById('days-link');
        let messageScreen = document.getElementById('message-screen');

        let addDayHandler = document.getElementById('add-day-btn');

        if (localStorage.getItem('token') === null) {
          logoutBtn.style.display = 'none';
          provisionsList.style.display = 'none';
          daysList.style.display = 'none';
          homeScreen.innerHTML = "<h2>Miejsce na jakiś fajny content, ale jeszcze nie wiemy jaki :/</h2>"
        } else {
          loginBtn.style.display = 'none';
          registerBtn.style.display = 'none';
          provisionsList.style.display = 'block';
          daysList.style.display = 'block';
        }

        if (localStorage.getItem('blind') === null) {
          $('link[href="https://bootswatch.com/4/darkly/bootstrap.css"]').prop('disabled', true);
        } else {
          $('link[href="https://bootswatch.com/4/darkly/bootstrap.css"]').prop('disabled', false);
        }

        blindBtn.addEventListener('click', () => {
          if (localStorage.getItem('blind') === null) {
            localStorage.setItem('blind', true);
            $('link[href="https://bootswatch.com/4/darkly/bootstrap.css"]').prop('disabled', true);
          } else {
            localStorage.removeItem('blind', true);
            $('link[href="https://bootswatch.com/4/darkly/bootstrap.css"]').prop('disabled', false);
          }
        });

        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('token');
          registerBtn.style.display = 'block';
          loginBtn.style.display = 'block';
          logoutBtn.style.display = 'none';
          homeScreen.innerHTML = '';
          provisionsList.style.display = 'none';
          daysList.style.display = 'none';
          messageScreen.innerHTML = '';
          localStorage.removeItem('provisionsSet');
          localStorage.removeItem('statusSet');
        });

        loginHandler.addEventListener('click', event => {
          event.preventDefault();
          localStorage.removeItem('provisionsSet');
          localStorage.removeItem('statusSet');

          let login = document.getElementById('loginUserName').value;
          let password = document.getElementById('loginPasswordInput').value;
          try{
            fetch(apiUrl+'/api/authorization/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              'username': login,
              'password': password
            })
          })
          .then(response => {
            if (response.status !== 200) {
              throw new Error(response.statusText)
            } else {
              return response.json()
            }
          })
          .then(data => {
            localStorage.setItem('token', data.token);
            $("#login-close-btn").click();
            registerBtn.style.display = 'none';
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'block';
            provisionsList.style.display = 'block';
            daysList.style.display = 'block';
            
            messageScreen.innerHTML = '<div class="m-2 alert alert-success" role="alert">Witaj ' + parseJwt(data.token).unique_name + '!</div>';
          })
          .catch(error => {
            console.error(error)
            messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">Nieprawidłowy login lub hasło</div>';
            $("#login-close-btn").click();
          });
          } catch(e){
            alert(e)
          }
        });

        registerHandler.addEventListener('click', event => {
          event.preventDefault();

          let login = document.getElementById('registerUserName').value;
          let password = document.getElementById('registerPasswordInput').value;
          let email = document.getElementById('registerEmail').value;
          let passwordConfirm = document.getElementById('registerPasswordConfirmInput').value;

          fetch(apiUrl+'/api/authorization/register', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                'username': login,
                'password': password,
                'passwordConfirm': passwordConfirm,
                'email': email
              })
            })
            .then(response => {
              if(response.status !== 200) {
                response.json().then(error => {
                  var errMsg = '<b>Nie udało sie utworzyć konta</b></br>';
                  for(var key in error) {
                    if (error.hasOwnProperty(key)) {
                      errMsg += error[key][0] + '</br>';
                    }
                  }
                  messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">'+errMsg+'</div>';
                })
                throw new Error(response.status);
              } else {
                return response.json();
              }
            })
            .then(data => {
              messageScreen.innerHTML = '<div class="m-2 alert alert-success" role="alert">' + data.message + '</div>';
              $("#register-close-btn").click();
            })
            .catch(error => {
              messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">Wystąpił nieznany błąd, przepraszamy za utrudnienia.</div>';
              $("#register-close-btn").click();
            })
        })

        provisionsList.addEventListener('click', event => {
          event.preventDefault();

          fetch(apiUrl+'/api/provisions/get',{
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer '+localStorage.getItem('token')
            }
          })
          .then(response => {
            if(response.status !== 200) {
              throw new Error(response.statusText);
            } else {
              return response.json();
            }
          })
          .then(data => {
            homeScreen.innerHTML = `<div class="row"><div class="col-xs-12 my-3 col-sm-8 offset-sm-2">
            <h4>Lista postanowień</h4>
              <table id="provisions-table" class="table table-striped table-bordered" style="width: 100%">
              <thead id='provisions-thead'>
                <th>Nazwa</th>
                <th>Opis</th>
                <th>Data rozpoczęcia</th>
                <th>Data zakończenia</th>
              </thead>
              <tbody id='provisions-tbody'>
              </tbody>
            </table>
            <button type="submit" class="btn btn-primary" id="add-new-provision" data-toggle="modal" data-target="#addProvisionModal">Dodaj</button>
            </div>
            </div>`
          

            let provisionsTableBody = document.getElementById('provisions-tbody');
            for(i=0; i<data.length; i++) {
              let tr = document.createElement('tr');
              let name = document.createElement('td');
              let startDate = document.createElement('td');
              let endDate = document.createElement('td');
              let description = document.createElement('td');
              name.innerHTML = data[i].name;
              startDate.innerHTML = formatDate(data[i].startDate);
              endDate.innerHTML = formatDate(data[i].endDate);
              description.innerHTML = data[i].description;
              tr.appendChild(name);
              tr.appendChild(startDate);
              tr.appendChild(endDate);
              tr.appendChild(description);

              provisionsTableBody.appendChild(tr);
            }
            homeScreen.style.display = 'block';

            $('#provisions-table').DataTable({
                  "language": {
                      "sProcessing": "Przetwarzanie...",
                      "sLengthMenu": "Pokaż _MENU_ pozycji",
                      "sZeroRecords": "Nie znaleziono pasujących pozycji",
                      "sInfoThousands": " ",
                      "sInfo": "Pozycje od _START_ do _END_ z _TOTAL_ łącznie",
                      "sInfoEmpty": "Pozycji 0 z 0 dostępnych",
                      "sInfoFiltered": "(filtrowanie spośród _MAX_ dostępnych pozycji)",
                      "sInfoPostFix": "",
                      "sSearch": "Szukaj:",
                      "sUrl": "",
                      "oPaginate": {
                          "sFirst": "Pierwsza",
                          "sPrevious": "Poprzednia",
                          "sNext": "Następna",
                          "sLast": "Ostatnia"
                      },
                      "sEmptyTable": "Brak danych",
                      "sLoadingRecords": "Wczytywanie...",
                      "oAria": {
                          "sSortAscending": ": aktywuj, by posortować kolumnę rosnąco",
                          "sSortDescending": ": aktywuj, by posortować kolumnę malejąco"
                      }
                  }
              });
          })
          .catch(error => {
            messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">' + error + '!</div>';
          })
        })

        daysList.addEventListener('click', event => {
          event.preventDefault();

          fetch(apiUrl+'/api/days/get',{
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer '+localStorage.getItem('token')
            }
          })
          .then(response => {
            if(response.status !== 200) {
              throw new Error(response.statusText);
            } else {
              return response.json();
            }
          })
          .then(data => {
            homeScreen.innerHTML = `<div class="row"><div class="col-xs-12 my-3 col-sm-8 offset-sm-2">
              <h4>Lista dni</h4>
              <table id="days-table" class="table table-striped table-bordered" style="width: 100%">
              <thead id='days-thead'>
                <th>Nazwa postanowienia</th>
                <th>Status wykonania</th>
                <th>Data rozpoczęcia</th>
                <th>Opis</th>
              </thead>
              <tbody id='days-tbody'>
              </tbody>
            </table>
            <button type="submit" class="btn btn-primary" id="add-new-day" data-toggle="modal" data-target="#addDaysModal">Dodaj</button>
            </div>
            </div>`
            
            let daysTableBody = document.getElementById('days-tbody');
            for(i=0; i<data.length; i++) {
              let tr = document.createElement('tr');
              let name = document.createElement('td');
              let statusName = document.createElement('td');
              let date = document.createElement('td');
              let description = document.createElement('td');
              name.innerHTML = data[i].provisionName;
              statusName.innerHTML = data[i].statusName;
              date.innerHTML = formatDate(data[i].date);
              description.innerHTML = data[i].description;
                                          if(data[i].statusName === "Wykonano") {
                                            statusName.style.color = "green";
                            } else if (data[i].statusName === "Nie wykonano") {
                              statusName.style.color = "red";
                            } else if (data[i].statusName === "Nie obowiązuje") {
                              statusName.style.color = "gray";
                            } else if (data[i].statusName === "Wykonano warunkowo") {
                              statusName.style.color = "orange";
                            }
              tr.appendChild(name);
              tr.appendChild(statusName);
              tr.appendChild(date);
              tr.appendChild(description);

              daysTableBody.appendChild(tr);
            }

            $('#days-table').DataTable({
                    "language": {
                        "sProcessing": "Przetwarzanie...",
                        "sLengthMenu": "Pokaż _MENU_ pozycji",
                        "sZeroRecords": "Nie znaleziono pasujących pozycji",
                        "sInfoThousands": " ",
                        "sInfo": "Pozycje od _START_ do _END_ z _TOTAL_ łącznie",
                        "sInfoEmpty": "Pozycji 0 z 0 dostępnych",
                        "sInfoFiltered": "(filtrowanie spośród _MAX_ dostępnych pozycji)",
                        "sInfoPostFix": "",
                        "sSearch": "Szukaj:",
                        "sUrl": "",
                        "oPaginate": {
                            "sFirst": "Pierwsza",
                            "sPrevious": "Poprzednia",
                            "sNext": "Następna",
                            "sLast": "Ostatnia"
                        },
                        "sEmptyTable": "Brak danych",
                        "sLoadingRecords": "Wczytywanie...",
                        "oAria": {
                            "sSortAscending": ": aktywuj, by posortować kolumnę rosnąco",
                            "sSortDescending": ": aktywuj, by posortować kolumnę malejąco"
                        }
                    }
                });
            homeScreen.style.display = 'block';
          })
          .catch(error => {
            //messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">' + error + '!</div>';
          })
        })

        addDayHandler.addEventListener('click', event => {
          event.preventDefault();

          let provisionId = document.getElementById('provisionSelection');
          provisionId = provisionId.options[provisionId.selectedIndex].value
          let dayDate = document.getElementById('dayDateInput').value;
          let statusName = document.getElementById('StatusInput');
          statusName.options[statusName.selectedIndex].value
          let dayDescription= document.getElementById('dayDescription').value;

          fetch(apiUrl+'/api/days/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer '+localStorage.getItem('token')
            },
            body: JSON.stringify({
                'provisionId': provisionId,
                'date': dayDate,
                'statusName': statusName,
                'description': dayDescription === null ? '' : dayDescription
              })
            })
            .then(response => {
              if(response.status !== 200) {
                throw new Error(response.statusText);
              } else {
                return response.json()
              }
            })
            .then(data => {
              //messageScreen.style.display = 'block';
              messageScreen.innerHTML = '<div class="m-2 alert alert-success" role="alert">' + data.message + '</div>';
              $("#addDay-close-btn").click();
              daysList.click();
            })
            .catch(error => {
              console.error(error);
              //messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">' + error + '!</div>';
            })
          });

        addProvisionHandler.addEventListener('click', event => {
          event.preventDefault();

          let provisionName = document.getElementById('provisionInput').value;
          let provisionStartDate = document.getElementById('startDateInput').value;
          let provisionEndDate = document.getElementById('endDateInput').value;
          let provisionDescription = document.getElementById('provisionDescription').value;

          fetch(apiUrl+'/api/provisions/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer '+localStorage.getItem('token')
            },
            body: JSON.stringify({
                'name': provisionName,
                'startDate': provisionStartDate,
                'endDate': provisionEndDate,
                'description': provisionDescription === null ? '' : provisionDescription
              })
            })
            .then(response => {
              if(response.status !== 200) {
                throw new Error(response.statusText);
              } else {
                return response.json()
              }
            })
            .then(data => {
              messageScreen.style.display = 'block';
              messageScreen.innerHTML = '<div class="m-2 alert alert-success" role="alert">' + data.message + '</div>';
              $("#addProvision-close-btn").click();
              provisionsList.click();
            })
            .catch(error => {
              console.error(error);
              //messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">' + error + '!</div>';
            })
          });
        })


        function parseJwt (token) {
          var base64Url = token.split('.')[1];
          var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));

          return JSON.parse(jsonPayload);
        };

        function formatDate(date) {
          try {
            if (date) {
              return (date.replace(/T/g, ' ')).replace(/\..*$/, '');             
            }
            return '';  
          } catch (e) {
            console.error(e.message);
            return '';
          }  
        }
    </script>
  </body>
</html>