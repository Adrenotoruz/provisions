<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link href="datatables/1.10.19/css/dataTables.bootstrap4.min.css" rel="stylesheet" />

    <title>Provisions</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">Provisions</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarText">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a id="register-link" class="nav-link" data-toggle="modal" data-target="#registerModal" href="#">Rejestracja</a>
            </li>
            <li class="nav-item">
              <a id="login-link" class="nav-link" data-toggle="modal" data-target="#loginModal" href="#">Logowanie</a>
            </li>
            <li class="nav-item">
              <a id="provisions-link" class="nav-link" data-target="#" href="#">Postanowienia</a>
            </li>
            <li class="nav-item">
              <a id="days-link" class="nav-link" data-toggle="modal" data-target="#" href="#">Dni</a>
            </li>
            <li class="nav-item">
              <a id="logout-link" class="nav-link" data-toggle="modal" data-target="#" href="#">Wyloguj się</a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- Modal -->
      <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="loginModalLabel">Logowanie</h5>
              <button type="button" class="close" data-dismiss="modal" id="login-close-btn" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="login-form">
                <div class="form-group">
                  <label for="loginUserName">Nazwa użytkownika</label>
                  <input type="login" class="form-control" id="loginUserName">
                </div>
                <div class="form-group">
                  <label for="loginPasswordInput">Hasło</label>
                  <input type="password" class="form-control" id="loginPasswordInput">
                </div>
                <button type="submit" class="btn btn-primary" id="login-submit">Zaloguj się</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="addProvisionModal" tabindex="-1" role="dialog" aria-labelledby="addProvisionModal" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addProvisionModal">Dodawanie nowego postanowienia</h5>
              <button type="button" class="close" data-dismiss="modal" id="addProvision-close-btn" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="login-form">
                <div class="form-group">
                  <label for="loginUserName">Nazwa postanowienia</label>
                  <input type="text" class="form-control" id="provisionInput">
                </div>
                <div class="form-group">
                  <label for="startDateInput">Data startu</label>
                  <input type="datetime-local" class="form-control" value="2020-06-13T13:00" id="startDateInput">
                </div>
                <div class="form-group">
                  <label for="endDateInput">Data zakończenia</label>
                  <input type="datetime-local" class="form-control" value="2021-06-13T13:00" id="endDateInput">
                </div>
                <div class="form-group">
                  <label for="provisionDescription">Opis postanowienia</label>
                  <input type="text" class="form-control" id="provisionDescription">
                </div>
                <button type="submit" class="btn btn-primary" id="add-provision-btn">Dodaj</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="registerModalLabel">Rejestracja</h5>
              <button type="button" class="close" id="register-close-btn" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <form id="register-form">
                <div class="form-group">
                  <label for="registerUserName">Nazwa użytkownika</label>
                  <input type="login" class="form-control" id="registerUserName">
                </div>
                <div class="form-group">
                  <label for="registerEmail">Email</label>
                  <input type="login" class="form-control" id="registerEmail">
                </div>
                <div class="form-group">
                  <label for="registerPasswordInput">Hasło</label>
                  <input type="password" class="form-control" id="registerPasswordInput">
                </div>
                <div class="form-group">
                  <label for="registerPasswordConfirmInput">Powtórz hasło</label>
                  <input type="password" class="form-control" id="registerPasswordConfirmInput">
                </div>
                <button type="submit" class="btn btn-primary" id="register-submit">Rejestracja</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div id="message-screen">

      </div>

      <div id="home-screen">

      </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="datatables/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="datatables/1.10.19/js/dataTables.bootstrap4.min.js"></script>
    <script src="tableInitializer.js"></script>
    <script>
      //TODO: Wersja testowa, do refactoringu

      const apiUrl = 'http://localhost:5000';

      window.addEventListener('load', () => {

        let addNewProvision = null;
        let registerBtn = document.getElementById('register-link');
        let loginBtn = document.getElementById('login-link');
        let logoutBtn = document.getElementById('logout-link');

        let loginHandler = document.getElementById('login-submit');
        let registerHandler = document.getElementById('register-submit');

        let homeScreen = document.getElementById('message-screen');

        let addProvisionHandler = document.getElementById('add-provision-btn');

        let provisionsList = document.getElementById('provisions-link');
        let daysList = document.getElementById('days-link');
        let messageScreen = document.getElementById('message-screen');

        if (localStorage.getItem('token') === null) {
          logoutBtn.style.display = 'none';
          homeScreen.style.display = 'none';
          provisionsList.style.display = 'none';
          daysList.style.display = 'none';
        } else {
          loginBtn.style.display = 'none';
          registerBtn.style.display = 'none';
          provisionsList.style.display = 'block';
          daysList.style.display = 'block';
        }

        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('token');
          registerBtn.style.display = 'block';
          loginBtn.style.display = 'block';
          logoutBtn.style.display = 'none';
          homeScreen.innerHTML = '';
          provisionsList.style.display = 'none';
          daysList.style.display = 'none';
          homeScreen.innerHTML = '';
        });

        loginHandler.addEventListener('click', event => {
          event.preventDefault();

          let login = document.getElementById('loginUserName').value;
          let password = document.getElementById('loginPasswordInput').value;
          try{
            fetch(apiUrl+'/api/authorization/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              'username': login,
              'password': password
            })
          })
          .then(response => {
            if (response.status !== 200) {
              throw new Error(response.statusText)
            } else {
              return response.json()
            }
          })
          .then(data => {
            localStorage.setItem('token', data.token);
            $("#login-close-btn").click();
            registerBtn.style.display = 'none';
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'block';
            provisionsList.style.display = 'block';
            daysList.style.display = 'block';
            
            messageScreen.innerHTML = '<div class="m-2 alert alert-success" role="alert">Witaj ' + parseJwt(data.token).unique_name + '!</div>';
          })
          .catch(error => {
            console.error(error)
            messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">' + error + '!</div>';
          });
          } catch(e){
            alert(e)
          }
        });

        registerHandler.addEventListener('click', event => {
          event.preventDefault();

          let login = document.getElementById('registerUserName').value;
          let password = document.getElementById('registerPasswordInput').value;
          let email = document.getElementById('registerEmail').value;
          let passwordConfirm = document.getElementById('registerPasswordConfirmInput').value;

          fetch(apiUrl+'/api/authorization/register', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                'username': login,
                'password': password,
                'passwordConfirm': passwordConfirm,
                'email': email
              })
            })
            .then(response => {
              if(response.status !== 200) {
                throw new Error(response.statusText);
              } else {
                return response.json();
              }
            })
            .then(data => {
              messageScreen.innerHTML = '<div class="m-2 alert alert-success" role="alert">' + data.message + '</div>';
              $("#register-close-btn").click();
            })
            .catch(error => {
              console.error(error);
              messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">' + error + '!</div>';
            })
        })

        provisionsList.addEventListener('click', event => {
          event.preventDefault();

          fetch(apiUrl+'/api/provisions/get',{
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer '+localStorage.getItem('token')
            }
          })
          .then(response => {
            if(response.status !== 200) {
              throw new Error(response.statusText);
            } else {
              return response.json();
            }
          })
          .then(data => {
            homeScreen.innerHTML = `<div class="row"><div class="col-xs-12 my-3 col-sm-8 offset-sm-2">
              <table id="provisions-table" class="table table-striped table-bordered" style="width: 100%">
              <thead id='provisions-thead'>
                <th>Nazwa</th>
                <th>Opis</th>
                <th>Data rozpoczęcia</th>
                <th>Data zakończenia</th>
              </thead>
              <tbody id='provisions-tbody'>
              </tbody>
            </table>
            <button type="submit" class="btn btn-primary" id="add-new-provision" data-toggle="modal" data-target="#addProvisionModal">Dodaj</button>
            </div>
            </div>`;

            let provisionsTableBody = document.getElementById('provisions-tbody');
            for(i=0; i<data.length; i++) {
              let tr = document.createElement('tr');
              let name = document.createElement('td');
              let startDate = document.createElement('td');
              let endDate = document.createElement('td');
              let description = document.createElement('td');
              name.innerHTML = data[i].name;
              startDate.innerHTML = data[i].startDate;
              endDate.innerHTML = data[i].endDate;
              description.innerHTML = data[i].description;
              tr.appendChild(name);
              tr.appendChild(startDate);
              tr.appendChild(endDate);
              tr.appendChild(description);

              provisionsTableBody.appendChild(tr);
            }
            homeScreen.style.display = 'block';
          })
          .catch(error => {
            messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">' + error + '!</div>';
          })
        })

        addProvisionHandler.addEventListener('click', event => {
          event.preventDefault();

          let provisionName = document.getElementById('provisionInput').value;
          let provisionStartDate = document.getElementById('startDateInput').value;
          let provisionEndDate = document.getElementById('endDateInput').value;
          let provisionDescription = document.getElementById('provisionDescription').value;

          fetch(apiUrl+'/api/provisions/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer '+localStorage.getItem('token')
            },
            body: JSON.stringify({
                'name': provisionName,
                'startDate': provisionStartDate,
                'endDate': provisionEndDate,
                'description': provisionDescription === null ? '' : provisionDescription
              })
            })
            .then(response => {
              if(response.status !== 200) {
                throw new Error(response.statusText);
              } else {
                return response.json()
              }
            })
            .then(data => {
              messageScreen.style.display = 'block';
              messageScreen.innerHTML = '<div class="m-2 alert alert-success" role="alert">' + data.message + '</div>';
              $("#addProvision-close-btn").click();
              provisionsList.click();
            })
            .catch(error => {
              console.error(error);
              messageScreen.innerHTML = '<div class="m-2 alert alert-danger" role="alert">' + error + '!</div>';
            })
          });
        })



        function parseJwt (token) {
          var base64Url = token.split('.')[1];
          var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));

          return JSON.parse(jsonPayload);
        };
    </script>
  </body>
</html>